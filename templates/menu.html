<!DOCTYPE html>
<html>
<head>
    <title>{{ shop.name }} - Menu</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1 class="main-title">{{ shop.name }} - Menu</h1>
        <div style="margin-bottom: 18px; display: flex; gap: 10px; justify-content: center;">
            <a href="?filter=veg" class="order-btn {% if filter_type == 'veg' %}active-filter{% endif %}">Veg</a>
            <a href="?filter=nonveg" class="order-btn {% if filter_type == 'nonveg' %}active-filter{% endif %}">Non-Veg</a>
        </div>
        <div class="card-list" style="flex-wrap: wrap; gap: 18px; justify-content: center;">
            {% for item in menu %}
            <form method="post" class="card add-to-cart-form" style="width: 220px; margin-bottom: 0; padding: 10px 10px 10px 10px; min-height: 110px; background: #fffde4; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start;">
                <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <span style="font-weight:700; color:#ff9800; font-size: 0.95rem;">â‚¹{{ item.price }}</span>
                    <span style="font-size: 0.80rem; color: #888;">{% if item.veg %}ðŸŸ¢ Veg{% else %}ðŸ”´ Non-Veg{% endif %}</span>
                </div>
                <span class="card-title" style="font-size: 0.92rem; font-weight: 700; color: #ff5722; white-space: pre-line; word-break: break-word; line-height: 1.2; margin-bottom: 8px;">{{ item.name }}</span>
                <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                    <label for="quantity_{{ item.id }}" style="font-size:0.80rem; color:#ff5722; font-weight:600;">Qty:</label>
                    <input type="number" name="quantity" id="quantity_{{ item.id }}" min="1" value="1" required style="width:38px; font-size:0.85rem;">
                    <input type="hidden" name="item_id" value="{{ item.id }}">
                    <button type="button" class="order-btn add-to-cart-btn" style="font-size:0.92rem; padding:5px 0; min-width: 80px;">Add to Cart</button>
                </div>
            </form>
            {% endfor %}
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 18px; flex-wrap: wrap;">
            <a href="/foodcourts/{{ court.id }}" class="back-link" style="font-size:0.92rem; padding: 3px 8px; margin-top:0; min-width: 90px; text-align: center;">Back to Shops</a>
        </div>

        <!-- Floating Cart Icon -->
        <a href="/cart" id="floating-cart" style="position: fixed; bottom: 24px; right: 24px; z-index: 1000; background: #fff; border-radius: 50%; box-shadow: 0 2px 8px rgba(255,87,34,0.18); width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; text-decoration: none;">
            <img src="https://cdn-icons-png.flaticon.com/512/1170/1170678.png" alt="Cart" style="width: 32px; height: 32px;">
            <span id="cart-count-badge" style="position: absolute; top: 8px; right: 8px; background: #ff5722; color: #fff; border-radius: 50%; font-size: 0.85rem; font-weight: 700; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;">{{ cart_count if cart_count is defined else (session['cart']|length if session['cart'] else 0) }}</span>
        </a>

        <script>
        // On page load, update cart badge from server
        fetch('/cart_count').then(r => r.json()).then(data => {
            document.getElementById('cart-count-badge').textContent = data.count;
        });
        </script>

        <script>
        // Intercept Add to Cart button to submit via AJAX and update cart count
        document.querySelectorAll('.add-to-cart-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                var form = btn.closest('form');
                var formData = new FormData(form);
                fetch(window.location.pathname + window.location.search, {
                    method: 'POST',
                    body: formData,
                }).then(function(response) {
                    if (response.ok) {
                        // Update cart badge
                        setTimeout(function() {
                            fetch('/cart_count').then(r => r.json()).then(data => {
                                document.getElementById('cart-count-badge').textContent = data.count;
                            });
                        }, 100);
                    }
                });
            });
        });
        </script>
    </div>